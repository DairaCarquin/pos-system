<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout}">
<head>
    <title>Listado de Cajas</title>
    <!-- No incluyas Bootstrap aquí si ya está en tu layout base -->
</head>
<body>
<div layout:fragment="contenido">
    <h2 class="mb-4">Listado de Cajas</h2>

    <!-- Barra de búsqueda más corta y alineada a la izquierda sobre la tabla -->
    <form th:action="@{/caja}" method="get" class="mb-3">
        <div class="d-flex">
            <input type="text" class="form-control form-control-sm me-2" style="max-width: 250px;" name="q"
                   placeholder="Buscar..." th:value="${param.q}">
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-search"></i> Buscar
            </button>
        </div>
    </form>

    <!-- Mensaje de error al editar caja -->
    <div th:if="${errorEditar}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorEditar}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Mensaje de error al eliminar caja -->
    <div th:if="${errorEliminar}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorEliminar}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Mensaje de error al cerrar caja -->
    <div th:if="${errorCerrar}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorCerrar}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Mensaje de éxito al abrir caja -->
    <div th:if="${param.aperturaExitosa}" class="alert alert-success alert-dismissible fade show" role="alert" id="aperturaSuccessMsg">
        Apertura de caja realizada.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Mensaje de éxito al cerrar caja -->
    <div th:if="${cierreExitosa}" class="alert alert-success alert-dismissible fade show" role="alert">
        Cierre de caja realizado.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Listado de Cajas</h5>
          <!-- Botón Nueva Caja visible para todos -->
          <a th:href="@{/caja/nuevo}" class="btn btn-light">
            <i class="bi bi-plus-circle"></i> Nueva Caja
          </a>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Local</th>
                    <th>Fecha de Creación</th>
                    <th>Usuario Creador</th>
                    <th class="text-center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="caja : ${cajas}">
                    <td th:text="${caja.id}"></td>
                    <td th:text="${caja.codigo}"></td>
                    <td th:text="${caja.nombre}"></td>
                    <td th:text="${caja.local != null ? caja.local.nombre : ''}"></td>
                    <td th:text="${#temporals.format(caja.fechaCreacion, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${caja.usuario != null ? caja.usuario.username : ''}"></td>
                    <td class="text-center">
                        <!-- Todos los botones visibles para todos -->
                        <a th:href="@{/caja/editar/{id}(id=${caja.id})}" class="btn btn-warning btn-sm me-2">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a th:href="@{/caja/eliminar/{id}(id=${caja.id})}"
                           class="btn btn-danger btn-sm me-2"
                           th:attr="onclick=${sesionesActivas.containsKey(caja.id)} ? 'mostrarMensajeCajaAbierta(event)' : 'return confirm(\'¿Eliminar esta caja?\')'">
                            <i class="bi bi-trash"></i> Eliminar
                        </a>
                        <button type="button" class="btn btn-success btn-sm me-2"
                                data-bs-toggle="modal"
                                th:attr="data-bs-target='#abrirCajaModal__' + ${caja.id}"
                                th:disabled="${sesionesActivas.containsKey(caja.id)}">
                            <i class="bi bi-box-arrow-in-right"></i> Abrir
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-toggle="modal"
                                th:attr="data-bs-target='#cerrarCajaModal__' + ${caja.id}"
                                th:disabled="${!sesionesActivas.containsKey(caja.id)}">
                            <i class="bi bi-box-arrow-left"></i> Cerrar
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
            <!-- Botón para ver sesiones debajo de la tabla -->
            <div class="mt-3 text-end">
                <a th:href="@{/caja-sesion}" class="btn btn-info">
                    <i class="bi bi-clock-history"></i> Ver Sesiones
                </a>
            </div>
            <!-- Modales fuera de la tabla -->
            <div th:each="caja : ${cajas}">
                <!-- Modal Abrir Caja -->
                <div th:id="'abrirCajaModal__' + ${caja.id}" class="modal fade" tabindex="-1"
                     th:attr="aria-labelledby='abrirCajaLabel__' + ${caja.id}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form th:action="@{/caja-sesion/abrir}" method="post">
                        <input type="hidden" name="cajaId" th:value="${caja.id}" />
                        <div class="modal-header">
                          <h5 class="modal-title" th:id="'abrirCajaLabel__' + ${caja.id}">Abrir Caja</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Monto Inicial</label>
                            <input type="number" class="form-control" name="montoInicial" required min="0" step="0.01">
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- Modal Cerrar Caja -->
                <div th:id="'cerrarCajaModal__' + ${caja.id}" class="modal fade" tabindex="-1"
                     th:attr="aria-labelledby='cerrarCajaLabel__' + ${caja.id}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form th:action="@{/caja-sesion/cerrar}" method="post">
                        <input type="hidden" name="cajaId" th:value="${caja.id}" />
                        <div class="modal-header">
                          <h5 class="modal-title" th:id="'cerrarCajaLabel__' + ${caja.id}">Cerrar Caja</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Monto de Cierre</label>
                            <input type="number" class="form-control" name="montoCierre" required min="0" step="0.01">
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
            </div>
            <!-- Fin de modales -->
        </div>
    </div>
</div>

<!-- Script para cerrar el modal y mostrar mensajes -->
<script th:inline="javascript">
    /* Cierra el modal si la apertura fue exitosa */
    var aperturaExitosa = /*[[${param.aperturaExitosa}]]*/ false;
    if (aperturaExitosa && aperturaExitosa.toString() === "true") {
        setTimeout(function() {
            var modals = document.querySelectorAll('.modal.show');
            modals.forEach(function(modal) {
                var modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
        }, 500);
    }

    // Mensaje para eliminar cuando la caja está abierta
    function mostrarMensajeCajaAbierta(event) {
        event.preventDefault();
        alert("Esta caja se encuentra abierta, no puede ser eliminada");
    }
</script>
</body>
</html>